<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gridworld</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            margin: 40px;
            background-color: #f4f4f4;
        }

        h2 { 
            font-size: 24px; 
            font-weight: bold; 
            color: #333; 
        }

        h3 { 
            font-size: 20px; 
            font-weight: bold; 
            color: #444; 
        }

        input[type="number"] { 
            width: 50px; 
            text-align: center; 
            padding: 5px; 
            margin-right: 5px; 
        }

        button {
            font-size: 16px;
            background-color: #888888;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s ease;
        }

        button:hover {
            background-color: #5a5a5a;
        }

        .grid-container {
            display: grid;
            column-gap: 18px; /* Âè™Ë™øÊï¥Ê∞¥Âπ≥ÈñìË∑ù */
            row-gap: 5px;    /* ÂèØÈÅ∏ÔºöÊéßÂà∂ÂûÇÁõ¥ÈñìË∑ù */
            margin-top: 10px;
            padding: 10px;
            border-collapse: collapse;
        }

        .grid-item {
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid black;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            border-radius: 5px; /* Ë®≠ÁΩÆÂúìËßíÔºåÊï∏ÂÄºË∂äÂ§ßÂúìËßíË∂äÊòéÈ°Ø */
        }

        /* ‚úÖ ËÆì Gridworld ÁΩÆ‰∏≠ */
        .grid-item:hover {
            transform: scale(1.1);
        }

        #grid-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        #matrix-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 40px;
            margin-top: 30px;
        }
        #simulation-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 40px;
            margin-top: 30px;
        }
        @media (max-width: 768px) {
            #matrix-container {
                flex-direction: column;
                align-items: center;
            }
        }

        .start { 
            background-color: #64a866; 
            color: white; 
        }

        .end { 
            background-color: #f5736a; 
            color: white; 
        }

        .obstacle { 
            background-color: #9E9E9E; 
            color: white; 
        }
    </style>
</head>
<body>

<h2>Gridworld</h2>
<p>Enter a number between 5 and 9: 
    <input type="number" id="grid-size" min="5" max="9">
    <button onclick="generateGrid()">Generate Square</button>
</p><br>
<p>
    a. Click on a cell to set up the start grid as green <br>
    b. Click on a cell to set up the end grid as red <br>
    c. Click on n-2 cells to set up the obstacle grid as gray
</p>

<!-- Gridworld ÂçÄÂüü -->
<div id="grid-container">
    <div>
        <h3><span id="grid-title">5 x 5 Square:</span></h3>
        <div id="grid" class="grid-container"></div><br>
        <button id="start-game" onclick="startGame()">Start Game</button>
    </div>
</div>

<div id="simulation-container">
    <!-- Maze Simulation -->
    <div id="maze-container">
        <h3>Simulation:</h3>
        <div id="maze-grid" class="grid-container"></div>
    </div>

    <!-- Value Matrix -->
    <div>
        <h3>Value Matrix (Final):</h3>
        <div id="value-matrix" class="grid-container"></div>
    </div>

    <!-- Policy Matrix -->
    <div>
        <h3>Policy Matrix (Final):</h3>
        <div id="policy-matrix" class="grid-container"></div>
    </div>
</div>

<script>
let gridSize = 5; 
let startCell = null;
let endCell = null;
let obstacles = new Set();

function generateGrid() {
    gridSize = parseInt(document.getElementById("grid-size").value);
    if (gridSize < 5 || gridSize > 9 || isNaN(gridSize)) {
        alert("Please enter a valid number between 5 and 9.");
        return;
    }

    $.ajax({
        url: "/set_size",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ size: gridSize }),
        success: function(response) {
            if (response.status === "success") {
                startCell = null;
                endCell = null;
                obstacles.clear();
                renderGrid();
            } else {
                alert(response.message);
            }
        },
        error: function(xhr) {
            console.log("AJAX Error:", xhr.responseText);
            alert("Error setting grid size.");
        }
    });
}

function renderGrid() {
    let grid = document.getElementById("grid");
    grid.innerHTML = "";
    grid.style.gridTemplateColumns = `repeat(${gridSize}, 40px)`;

    for (let row = 0; row < gridSize; row++) {
        for (let col = 0; col < gridSize; col++) {
            let cell = document.createElement("div");
            cell.classList.add("grid-item");
            cell.textContent = row * gridSize + col + 1;
            cell.dataset.row = row;
            cell.dataset.col = col;
            cell.addEventListener("click", () => handleCellClick(cell));
            grid.appendChild(cell);
        }
    }
    document.getElementById("grid-title").textContent = `${gridSize} x ${gridSize} Square:`;
}

function handleCellClick(cell) {
    let row = parseInt(cell.dataset.row);
    let col = parseInt(cell.dataset.col);
    let cellPos = [row, col];

    if (startCell && startCell[0] === row && startCell[1] === col) {
        startCell = null;
        cell.className = "grid-item";
    } else if (endCell && endCell[0] === row && endCell[1] === col) {
        endCell = null;
        cell.className = "grid-item";
    } else if (obstacles.has(JSON.stringify(cellPos))) {
        obstacles.delete(JSON.stringify(cellPos));
        cell.className = "grid-item";
    } else if (!startCell) {
        startCell = cellPos;
        cell.className = "grid-item start";
    } else if (!endCell) {
        endCell = cellPos;
        cell.className = "grid-item end";
    } else if (obstacles.size < gridSize - 2) {
        obstacles.add(JSON.stringify(cellPos));
        cell.className = "grid-item obstacle";
    } else {
        alert(`You can only place up to ${gridSize - 2} obstacles.`);
    }
}

function startGame() {
    if (!startCell || !endCell) {
        alert("Please select both a start and end cell.");
        return;
    }

    let obstacleList = Array.from(obstacles).map(JSON.parse);

    $.ajax({
        url: "/find_best_path",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
            start: startCell,
            end: endCell,
            obstacles: obstacleList,
            grid_size: gridSize
        }),
        success: function(response) {
            if (response.status === "success") {
                renderMatrix("value-matrix", response.value_matrix, false);
                renderMatrix("policy-matrix", response.policy_matrix, true);

                let paths = response.paths;
                let finalPath = response.final_best_path; // üÜï ÂèñÂæóÊúÄÂÑ™Ë∑ØÂæë

                showMaze();

                // ‚úÖ Á≠âÂæÖÂãïÁï´Êí≠ÊîæÂÆåÁï¢ÔºåÂÜçÈ°ØÁ§∫ÊúÄÂÑ™Ë∑ØÂæë
                animatePaths(paths, () => {
                    highlightFinalPath(finalPath);
                });

            } else {
                alert(response.message);
            }
        },
        error: function(xhr) {
            alert("Error calculating matrices.");
        }
    });
}

function highlightFinalPath(finalPath) {
    for (let i = 0; i < finalPath.length; i++) {
        setTimeout(() => {
            let cell = finalPath[i];
            let nextCell = i < finalPath.length - 1 ? finalPath[i + 1] : null; // ‰∏ã‰∏ÄÊ≠•
            let cellElement = document.querySelector(`#maze-grid [data-row="${cell[0]}"][data-col="${cell[1]}"]`);

            if (cellElement) {
                // ‚úÖ Á¢∫‰øùËµ∑Èªû & ÁµÇÈªûÈ°èËâ≤‰∏çËÆäÔºå‰∏îÁµÇÈªû‰∏çÈ°ØÁ§∫ÁÆ≠È†≠
                if (JSON.stringify(cell) !== JSON.stringify(startCell) && JSON.stringify(cell) !== JSON.stringify(endCell)) {
                    cellElement.style.backgroundColor = "#FFD700"; // üèÜ ÊúÄÂÑ™Ë∑ØÂæëÊ®ôË®òÁÇ∫ÈáëÈªÉËâ≤
                } else if (JSON.stringify(cell) === JSON.stringify(startCell)) {
                    cellElement.style.backgroundColor = "#64a866"; // ‚úÖ ‰øùÊåÅËµ∑ÈªûÁ∂†Ëâ≤
                } else if (JSON.stringify(cell) === JSON.stringify(endCell)) {
                    cellElement.style.backgroundColor = "#f5736a"; // ‚úÖ ‰øùÊåÅÁµÇÈªûÁ¥ÖËâ≤
                    cellElement.textContent = ""; // ‚úÖ Á¢∫‰øùÁµÇÈªû‰∏çÈ°ØÁ§∫ÁÆ≠È†≠
                }

                cellElement.style.color = "black"; // ‚úÖ Ë®≠ÂÆöÁÆ≠È†≠È°èËâ≤ÁÇ∫ÈªëËâ≤

                // ‚úÖ Âè™ÊúâÁï∂ `nextCell` Â≠òÂú®ÊôÇÔºåÊâçË®àÁÆóÁÆ≠È†≠ÊñπÂêë
                if (nextCell) {
                    let arrow = getArrowDirection(cell, nextCell);
                    cellElement.textContent = arrow; // üèπ È°ØÁ§∫ÁÆ≠È†≠
                }
            }
        }, i * 150);
    }
}

function getArrowDirection(current, next) {
    let [currRow, currCol] = current;
    let [nextRow, nextCol] = next;

    if (nextRow < currRow) return "‚Üë";  // ÂæÄ‰∏ä
    if (nextRow > currRow) return "‚Üì";  // ÂæÄ‰∏ã
    if (nextCol < currCol) return "‚Üê";  // ÂæÄÂ∑¶
    if (nextCol > currCol) return "‚Üí";  // ÂæÄÂè≥
    return "";
}

function showMaze() {
    let maze = document.getElementById("maze-grid");
    maze.innerHTML = "";
    maze.style.gridTemplateColumns = `repeat(${gridSize}, 40px)`;
    maze.style.display = "grid";

    for (let row = 0; row < gridSize; row++) {
        for (let col = 0; col < gridSize; col++) {
            let cell = document.createElement("div");
            cell.classList.add("grid-item");
            cell.dataset.row = row;
            cell.dataset.col = col;

            let cellPos = JSON.stringify([row, col]);
            if (startCell && startCell[0] === row && startCell[1] === col) {
                cell.classList.add("start");
            } else if (endCell && endCell[0] === row && endCell[1] === col) {
                cell.classList.add("end");
            } else if (obstacles.has(cellPos)) {
                cell.classList.add("obstacle");
            }

            maze.appendChild(cell);
        }
    }
}

function closeMaze() {
    document.getElementById("maze-container").style.display = "none";
}

function animatePaths(paths, callback) {
    let iteration = 0;

    function animatePath() {
        if (iteration >= paths.length) {
            if (callback) callback(); // ‚úÖ ÂãïÁï´ÁµêÊùüÂæåÂü∑Ë°å callback (È°ØÁ§∫ÊúÄÂÑ™Ë∑ØÂæë)
            return;
        }

        let path = paths[iteration];
        let previousCell = null;

        path.forEach((cell, index) => {
            setTimeout(() => {
                let cellElement = document.querySelector(`#maze-grid [data-row="${cell[0]}"][data-col="${cell[1]}"]`);
                
                // ‚úÖ ÊÅ¢Âæ©Ââç‰∏ÄÊ≠•ÁöÑÈ°èËâ≤ & Ê∏ÖÈô§ÁÆ≠È†≠
                if (previousCell) {
                    let prevElement = document.querySelector(`#maze-grid [data-row="${previousCell[0]}"][data-col="${previousCell[1]}"]`);
                    if (prevElement) {
                        if (JSON.stringify(previousCell) === JSON.stringify(startCell)) {
                            prevElement.classList.add("start");
                            prevElement.style.backgroundColor = "#64a866"; // ‚úÖ Ëµ∑ÈªûÁ∂†Ëâ≤‰∏çËÆä
                            prevElement.textContent = ""; // Ê∏ÖÈô§ÁÆ≠È†≠
                        } else if (JSON.stringify(previousCell) === JSON.stringify(endCell)) {
                            prevElement.classList.add("end");
                            prevElement.style.backgroundColor = "#f5736a"; // ‚úÖ ÁµÇÈªûÁ¥ÖËâ≤‰∏çËÆä
                            prevElement.textContent = ""; // Á¢∫‰øùÁµÇÈªû‰∏çÈ°ØÁ§∫ÁÆ≠È†≠
                        } else if (obstacles.has(JSON.stringify(previousCell))) {
                            prevElement.classList.add("obstacle");
                            prevElement.textContent = ""; // Ê∏ÖÈô§ÁÆ≠È†≠
                        } else {
                            prevElement.style.backgroundColor = "#FFFFFF"; // ‚úÖ ÊôÆÈÄöË∑ØÂæëÊÅ¢Âæ©ÁôΩËâ≤
                            prevElement.textContent = ""; // Ê∏ÖÈô§ÁÆ≠È†≠
                        }
                    }
                }

                // ‚úÖ Êõ¥Êñ∞Áï∂ÂâçÊ≠•È©üÁöÑÈ°èËâ≤ & È°ØÁ§∫ÁÆ≠È†≠
                if (cellElement) {
                    // ‚úÖ ÊôÆÈÄöË∑ØÂæëÈ°èËâ≤ËÆäÁÇ∫ lightgreen
                    if (JSON.stringify(cell) === JSON.stringify(startCell)) {
                        cellElement.style.backgroundColor = "#64a866"; // ‚úÖ Ëµ∑ÈªûÁ∂†Ëâ≤
                    } else if (JSON.stringify(cell) === JSON.stringify(endCell)) {
                        cellElement.style.backgroundColor = "#f5736a"; // ‚úÖ ÁµÇÈªûÁ¥ÖËâ≤‰∏çËÆä
                        cellElement.textContent = ""; // ‚úÖ Á¢∫‰øùÁµÇÈªû‰∏çÈ°ØÁ§∫ÁÆ≠È†≠
                    } else {
                        cellElement.style.backgroundColor = "#90EE90"; // ‚úÖ ÊôÆÈÄöË∑ØÂæë lightgreen
                    }

                    cellElement.style.color = "black"; // ‚úÖ Ë®≠ÂÆöÁÆ≠È†≠ÁÇ∫ÈªëËâ≤

                    if (previousCell && JSON.stringify(cell) !== JSON.stringify(endCell)) {
                        let arrow = getArrowDirection(previousCell, cell);
                        cellElement.textContent = arrow; // üèπ È°ØÁ§∫ÁÆ≠È†≠
                    }
                }

                previousCell = cell; // ‚úÖ Êõ¥Êñ∞Ââç‰∏ÄÊ≠•ÁöÑ cell
            }, index * 100);
        });

        iteration++;
        setTimeout(animatePath, path.length * 100);
    }

    animatePath();
}

function renderMatrix(id, matrix, isPolicy) {
    let container = document.getElementById(id);
    container.innerHTML = "";
    container.style.gridTemplateColumns = `repeat(${gridSize}, 40px)`;

    for (let row = 0; row < gridSize; row++) {
        for (let col = 0; col < gridSize; col++) {
            let cell = document.createElement("div");
            cell.classList.add("grid-item");

            // ‚úÖ ‰øùÁïôÊ†ºÂ≠êÈ°èËâ≤ (start, end, obstacle)
            let cellPos = JSON.stringify([row, col]);
            if (startCell && startCell[0] === row && startCell[1] === col) {
                cell.classList.add("start");
            } else if (endCell && endCell[0] === row && endCell[1] === col) {
                cell.classList.add("end");
            } else if (obstacles.has(cellPos)) {
                cell.classList.add("obstacle");
            }

            // ‚úÖ Ë®≠ÂÆöÊï∏ÂÄºÊàñÁÆ≠È†≠
            if (isPolicy) {
                let actions = matrix[row][col];
                cell.innerHTML = actions.replace(/‚Üë/g, "‚Üë ")
                                        .replace(/‚Üì/g, "‚Üì ")
                                        .replace(/‚Üê/g, "‚Üê ")
                                        .replace(/‚Üí/g, "‚Üí ");
            } else {
                cell.textContent = matrix[row][col].toFixed(2);
            }

            container.appendChild(cell);
        }
    }
}

window.onload = renderGrid;
</script>

</body>
</html>
